@page "/review-documentForSigning/{SigningTaskId}"
@page "/review-documentForSigning/{SigningTaskId}/{SubModuleId}/{TaskId}"
@using FATWA_DOMAIN.Models.ViewModel.TaskVMs;
@using FATWA_WEB.Pages.CaseManagment.Files
@using FATWA_WEB.Pages.CaseManagment.RegisteredCase
@using FATWA_WEB.Pages.CaseManagment.Request
@using static FATWA_DOMAIN.Enums.GeneralEnums;
@using static FATWA_DOMAIN.Enums.CaseManagementEnums;
@using FATWA_DOMAIN.Models.ViewModel.CaseManagment;
@using Syncfusion.Blazor.PdfViewer
@using Syncfusion.Blazor.PdfViewerServer
@using static FATWA_DOMAIN.Enums.TaskEnums;
@layout MainLayout
<PageTitle>@translationState.Translate("View_Details")</PageTitle>
<RadzenContent Container="main">
    <ChildContent>
        <div class="row breadcrumbBar justify-content-center align-items-center pb-3">
            <div class="col-md-6">
                <div class="row no-gutters">
                    <RadzenBreadCrumb>
                        <RadzenBreadCrumbItem Path="/Index" Text="@translationState.Translate("Home")" />
                        <RadzenBreadCrumbItem Path="/usertask-list" Text="@translationState.Translate("Tasks_List")" />
                        <RadzenBreadCrumbItem Text="@translationState.Translate("View_Details")" />
                    </RadzenBreadCrumb>
                </div>
            </div>
            <div class="col-md-6 d-flex justify-content-end">
                <div class="backtoDashboard">
                    <RadzenButton ButtonStyle="ButtonStyle.Secondary"
                                  Size="ButtonSize.Small"
                                  title="@translationState.Translate("Go_Back")"
                                  class="returnBtn" Icon="@(System.Globalization.CultureInfo.CurrentCulture.Name == "en-US"? "arrow_back" : "arrow_forward")" Click="@RedirectBack" />

                    <RadzenButton ButtonStyle="ButtonStyle.Secondary"
                                  Size="ButtonSize.Small"
                                  title="@translationState.Translate("Go_Back_Dashboard")"
                                  class="returnBtn" Icon="dashboard" Click="@GoBackDashboard" />
                    <RadzenButton ButtonStyle="ButtonStyle.Secondary"
                                  Size="ButtonSize.Small"
                                  title="@translationState.Translate("Go_Back_HomeScreen")"
                                  class="returnBtn"
                                  Icon="home" Click="@GoBackHomeScreen" />
                </div>
            </div>
        </div>

        <div class="row TitleBar justify-content-left align-items-center py-4">
            <div class="col-md-6">
                <div class="row no-gutters">
                    <RadzenHeading Size="H1" Text="@translationState.Translate("Entity_Details")" />
                </div>
            </div>
        </div>
        <RadzenAccordion>
            <Items>
                <RadzenAccordionItem Text="@translationState.Translate("Entity_Details")" Selected="true">
                    @if (taskForDS.ReferenceId != null)
                    {
                        @if (SubModule == (int)SubModuleEnum.CaseRequest)
                        {
                            <CaseRequestMetaDataGrid RequestId="Guid.Parse(taskForDS.ReferenceId)" />
                        }
                        else if (SubModule == (int)SubModuleEnum.CaseFile)
                        {
                            <CaseFileMetaDataGrid FileId="Guid.Parse(taskForDS.ReferenceId)" />
                        }
                        else if (SubModule == (int)SubModuleEnum.RegisteredCase)
                        {
                            <RegisteredCaseMetaDataGrid CaseId="Guid.Parse(taskForDS.ReferenceId)" />
                        }
                    }
                </RadzenAccordionItem>
            </Items>
        </RadzenAccordion>

        <RadzenFieldset class="pt-3" Text="@translationState.Translate("Remarks")">
            <div class="tableContent table-responsive">
                <RadzenDataGrid AllowFiltering="false"
                                @ref="grid"
                                AllowPaging="true"
                                AllowSorting="true"
                                Data="@DraftDocumentReasons"
                                TItem="CmsDraftedDocumentReasonVM"
                                Count="@(DraftDocumentReasons != null ? DraftDocumentReasons.Count() : 0)"
                                PageSize="@systemSettingState.Grid_Pagination"
                                PagerHorizontalAlign="Radzen.HorizontalAlign.Center"
                                PageSizeText="@translationState.Translate("Items_Per_Page")"
                                PageSizeOptions="@systemSettingState.Page_Size_Options"
                                EmptyText="@translationState.Translate("No_record_found")"
                                PagingSummaryFormat="@(translationState.PageSummaryFormat != null ? translationState.PageSummaryFormat : "")"
                                ShowPagingSummary="true">
                    <Columns>
                        <RadzenDataGridColumn TItem="CmsDraftedDocumentReasonVM" Property="Reason" Title="@translationState.Translate("Remarks")">
                            <Template Context="reason">
                                @if (reason.Reason != null)
                                {
                                    @if (reason.Reason.Length > 50)
                                    {
                                        @reason.Reason.Substring(0, 50) <a href="#" @onclick="@(() => OnDescriptionFullReasonDetail(reason.Reason))" @onclick:preventDefault>@translationState.Translate("Role_Description_3_dot")</a>
                                    }
                                    else
                                    {
                                        @reason.Reason
                                    }
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="CmsDraftedDocumentReasonVM" Property=@(Thread.CurrentThread.CurrentUICulture.Name == "en-US" ? "UserNameEn" : "UserNameAr") Title="@translationState.Translate("Sent_By")" />
                        <RadzenDataGridColumn TItem="CmsDraftedDocumentReasonVM" Property="CreatedDate" FormatString="{0:dd/MM/yyyy}" Title="@translationState.Translate("Date")" Width="80px" />
                    </Columns>
                </RadzenDataGrid>
            </div>
        </RadzenFieldset>


        <RadzenFieldset class="pt-3" Text="@translationState.Translate("Document_Viewer")">
            <div class="col-md-12">
                <div class="row justify-content-right ">
                    @if (ShowDocumentViewer)
                    {
                        @* <TelerikPdfViewer @ref="PdfViewerRef"
                            Width="100%"
                            Height="1000px"
                            Data="@FileData"
                            Class="m-3" /> *@
                        <SfPdfViewerServer EnableNavigationToolbar="false"
                                           Width="100%"
                                           Height="1000px"
                                           @ref="@pdfViewer"
                                           EnableRtl="@(Thread.CurrentThread.CurrentUICulture.Name == "en-US" ? false : true)"
                                           Locale="@(Thread.CurrentThread.CurrentUICulture.Name)"
                                           ID="pdfviewerDetailCommunication"
                                           DocumentPath="@DocumentPath"
                                           InteractionMode="InteractionMode.Pan">
                        </SfPdfViewerServer>
                    }
                </div>
            </div>
        </RadzenFieldset>

        <div class="buttoncontainer">
            <input type="checkbox" id="toggle" />
            <label class="floatingbutton" for="toggle"></label>
            <nav class="nav">
                <ul>
                    <TelerikButton Class="cancleBtn"
                                   ButtonType="Telerik.Blazor.ButtonType.Button"
                                   ThemeColor="light"
                                   OnClick="@BtnBack"> @translationState.Translate("Back") </TelerikButton>
                    @if (taskForDS.SigningTaskId != Guid.Empty)
                    {
                         <TelerikButton Class="cancleBtn"
                                   ButtonType="Telerik.Blazor.ButtonType.Button"
                                   OnClick="@BtnView"
                                   ThemeColor="light"> @translationState.Translate("View_Details")</TelerikButton>
                    }
                    @if (taskDetailVM.TaskId != Guid.Empty && taskDetailVM.TaskStatusId == (int)TaskStatusEnum.Pending)
                    {
                        <TelerikButton Class="cancleBtn"
                                       ButtonType="Telerik.Blazor.ButtonType.Button"
                                       ThemeColor="light" OnClick="@RejectToSignDocument">@translationState.Translate("Reject")</TelerikButton>
                        <TelerikButton Class="cancleBtn"
                                       ButtonType="Telerik.Blazor.ButtonType.Button"
                                       ThemeColor="light" OnClick="@SignDocument">@translationState.Translate("Sign_Document")</TelerikButton>
                    }
                </ul>
            </nav>
        </div>
    </ChildContent>
</RadzenContent>

@code {
    async Task OnDescriptionFullReasonDetail(string args)
    {
        await dialogService.OpenAsync(@translationState.Translate("Reason"), ds =>
    @<div>
        <p class="mb-4" style="min-height:200px;min-width:550px;line-height:2.5">@args</p>
    </div>);
    }
}