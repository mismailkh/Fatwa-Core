@page "/    "
@using FATWA_WEB.Pages.Shared
@using FATWA_DOMAIN.Models
@using FATWA_DOMAIN.Models.ViewModel;
@using FATWA_DOMAIN.Models.ViewModel.LegalPrinciple;
@using static FATWA_DOMAIN.Enums.LegalLegislationEnum;
@using static FATWA_DOMAIN.Enums.WorkflowModuleAndActivitiesEnum;
@using static FATWA_DOMAIN.Enums.GeneralEnums;
@using FATWA_DOMAIN.Models.ViewModel.DmsVMs;
@using Syncfusion.Blazor
@using System.Text.Json
@using Syncfusion.Blazor.PdfViewer
@using Syncfusion.Blazor.PdfViewerServer

@layout MainLayout
<!-- <History Author = 'Umer Zaman' Date='2022-10-10' Version="1.0" Branch="master">Add legislation dialog for upload or search document</History> -->
<PageTitle>@translationState.Translate("Add_Legislation_Source_Docuemnt")</PageTitle>
    @if (loginState.ClaimList.Where(x => x.Value == "Permissions.LDS.Legislation.Add").Count() > 0)
{
    <RadzenContent Container="main">
        <ChildContent>
            <RadzenTabs TabPosition="Radzen.TabPosition.Top" RenderMode="TabRenderMode.Server" Change="OnTabChange">
                <Tabs>
                    <RadzenTabsItem Text="@translationState.Translate("Kuwait_AlYawm_Document")">
                        <div class="row pb-2">
                            <div class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                                <RadzenFieldset AllowCollapse="false" Style=" margin: 20px auto;">
                                    <HeaderTemplate>
                                        <span class="d-inline-flex align-items-center align-middle">
                                            <b>@translationState.Translate("Advanced_Search")</b>
                                        </span>
                                    </HeaderTemplate>
                                    <ChildContent>
                                        <div class="row" style="margin-top:5px !important">
                                            <div class="col-md-12">
                                                <RadzenTemplateForm Data="@fileSearch" Visible="@(fileSearch != null)" TItem="LegalLegislationSourceDocSearchVM" Submit="@SubmitAdvanceSearch">
                                                    <ChildContent>
                                                        <div class="row">
                                                            <div class="col-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
                                                                <RadzenLabel Text="@(translationState.Translate("Document_Title"))" Component="FileTitle" />
                                                                <RadzenTextBox Placeholder="@translationState.Translate("Document_Title")" @bind-Value="@(advanceSearchVM.DocumentTitle)" Name="FileTitle" />
                                                            </div>
                                                            <div class="col-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
                                                                <RadzenLabel Text="@translationState.Translate("Edition_Number")" Component="Filename" />
                                                                <RadzenTextBox Placeholder="@translationState.Translate("Edition_Number")" @bind-Value="@advanceSearchVM.EditionNumber" Name="Filename" />
                                                            </div>
                                                            <div class="col-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
                                                                <RadzenLabel Text="@translationState.Translate("Publication_Date_From")" Component="CreatedFrom" />
                                                                <RadzenDatePicker DateFormat="dd/MM/yyyy" Class="w-100" Name="PublicationFrom" @bind-Value="@advanceSearchVM.PublicationFrom" />
                                                            </div>
                                                            <div class="col-12 col-sm-12 col-md-3 col-lg-3 col-xl-3">
                                                                <RadzenLabel Text="@translationState.Translate("Publication_Date_To")" Component="CreatedTo" />
                                                                <RadzenDatePicker DateFormat="dd/MM/yyyy" Class="w-100" Name="PublicationTo" @bind-Value="@advanceSearchVM.PublicationTo" />
                                                            </div>

                                                        </div>
                                                        <div class="row justify-content-end pt-3">
                                                            <div class="col-md-6" style="text-align:right;">
                                                                <RadzenButton ButtonType="Radzen.ButtonType.Submit" Icon="search" Text="@translationState.Translate("Grid_Search")" />
                                                                @if (Keywords == true)
                                                                {
                                                                    <RadzenButton ButtonSize="Radzen.ButtonSize.Medium" Icon="find_replace" Text="@translationState.Translate("Reset")" Click="ResetForm" />
                                                                }
                                                            </div>
                                                        </div>
                                                    </ChildContent>
                                                </RadzenTemplateForm>
                                            </div>
                                        </div>
                                    </ChildContent>
                                </RadzenFieldset>

                                <div class="row no-gutters">
                                    <div class="col-md-4">
                                        <RadzenTextBox class="searchBox"
                                                       Placeholder="@translationState.Translate("Grid_Search")"
                                                       Name="Textbox0"
                                                       @oninput="@(async(args) => {search = $"{args.Value}";await KayFileGrid.GoToPage(0);await OnSearchInput();})" />
                                    </div>

                                </div>
                                <div class="row tableContent table-responsive no-gutters pb-3">
                                    <RadzenDataGrid EmptyText="@translationState.Translate("No_record_found")"
                                                    AllowPaging="true"
                                                    AllowSorting="true"
                                                    FilterMode="Radzen.FilterMode.Advanced"
                                                    Count="@(DocumentList?.Any() == true ? DocumentList.FirstOrDefault().TotalCount : 0)"
                                                    @ref="KayFileGrid"
                                                    @bind-Value="kayselectedDocuments"
                                                    Data="@FilteredDocumentList"
                                                    LoadData=@OnLoadData
                                                    Sort="@OnSortData"
                                                    SelectionMode="DataGridSelectionMode.Single"
                                                    AllowRowSelectOnRowClick="true"
                                                    PageSize="@systemSettingState.Grid_Pagination"
                                                    PagerHorizontalAlign="Radzen.HorizontalAlign.Center"
                                                    PageSizeText="@translationState.Translate("Items_Per_Page")"
                                                    PageSizeOptions="@systemSettingState.Page_Size_Options"
                                                    PagingSummaryFormat="@(translationState.PageSummaryFormat != null ? translationState.PageSummaryFormat : "")"
                                                    ShowPagingSummary="true"
                                                    TItem="DMSKayPublicationDocumentListVM"
                                                    ColumnWidth="150px">
                                        <Columns>
                                            <RadzenDataGridColumn TItem="DMSKayPublicationDocumentListVM" Width="50px" Sortable="false" Filterable="false">
                                                <Template Context="kaydata">
                                                    <RadzenCheckBox TriState="false"
                                                                Value="@(kayselectedDocuments != null && kayselectedDocuments.Contains(kaydata))"
                                                                TValue="bool"
                                                                Change=@(args => { if(!allowRowSelectOnRowClick) { KayFileGrid.SelectRow(kaydata); }}) />
                                                </Template>
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="DMSKayPublicationDocumentListVM" Title="@translationState.Translate("Action")" Filterable="false" Sortable="false" Width="100px" TextAlign="TextAlign.Center">
                                                <Template Context="attachment">
                                                    <RadzenButton ButtonStyle="ButtonStyle.Info" Icon="visibility" Class="viewIcon" Click="@(args => ViewKayAttachement(attachment))" @onclick:stopPropagation="true" Disabled="attachment.StoragePath == null">
                                                    </RadzenButton>
                                                    <RadzenButton ButtonStyle="ButtonStyle.Secondary" Icon="download" Class="m-1" Click="@(args => DownloadAttachement(attachment))" @onclick:stopPropagation="true" Disabled="attachment.StoragePath == null">
                                                    </RadzenButton>
                                                </Template>
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="DMSKayPublicationDocumentListVM" Property="DocumentTitle" Title="@translationState.Translate("Document_Title")"/>
                                            <RadzenDataGridColumn TItem="DMSKayPublicationDocumentListVM" Property="PublicationDate" FormatString="{0:dd/MM/yyyy}" Title="@translationState.Translate("Publication_Date")"/>
                                            <RadzenDataGridColumn TItem="DMSKayPublicationDocumentListVM" Property="PublicationDateHijri" Title="@translationState.Translate("Publication_Date_Hijri")"/>
                                            <RadzenDataGridColumn TItem="DMSKayPublicationDocumentListVM" Property="EditionNumber" Title="@translationState.Translate("Edition_Number")"/>
                                            <RadzenDataGridColumn TItem="DMSKayPublicationDocumentListVM" Property="EditionType" Title="@translationState.Translate("Edition_Type")"/>
                                        </Columns>
                                    </RadzenDataGrid>
                                </div>
                            </div>
                        </div>
                    </RadzenTabsItem>
                    <RadzenTabsItem Text="@translationState.Translate("External_Source_Documents")">
                        <div class="row">
                            <div class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                                <FileUpload ModuleId="(int)WorkflowModuleEnum.LDSDocument"
                                            MandatoryAttachmentTypeId="(int)AttachmentTypeEnum.LdsExternalSource"
                                            ReferenceGuid="@legalLegislation.LegislationId"
                                            Multiple="true" MaxFileSize="@systemSettingState.File_Maximum_Size"
                                            FileTypes="@(systemSettingState.FileTypes.ToList())"
                                            UploadFrom="Legislation">
                                </FileUpload>
                            </div>
                        </div>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>
            <div class="row mt-4 popup-buttons-alignment">
                <div class="col-12 p-0">
                    <RadzenButton ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Text="@translationState.Translate("Submit")" Click="@SubmitDocumentSelection">
                    </RadzenButton>
                    <RadzenButton ButtonStyle="ButtonStyle.Light" style="margin-left: 1rem" Text="@translationState.Translate("Cancel")" Click="@CloseDialog">
                    </RadzenButton>
                </div>
            </div>

            <TelerikWindow Class="kayPublicationPreviewWindow" Size="@(ThemeConstants.Window.Size.Medium)" Visible="@(DisplayDocumentViewer && !busyPreviewBtn)" Draggable="true" Top="0%" Left="0%">
        <WindowTitle>
            <RadzenHeading Size="H2" Text="@translationState.Translate("Document_Preview")" />
        </WindowTitle>
        <WindowActions>
            <WindowAction Name="Upload" Icon="launch"
                          OnClick="@OpenInNewWindow" />
            <WindowAction Name="Minimize"></WindowAction>
            <WindowAction Name="Close" OnClick="@( () => DisplayDocumentViewer = false )"></WindowAction>
        </WindowActions>
        <WindowContent>
            @if (DisplayDocumentViewer && !busyPreviewBtn)
            {
                <div class="row pb-2 h-100">
                    <div class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                        <SfPdfViewerServer EnableNavigationToolbar="false"
                                           ZoomMode="ZoomMode.FitToWidth"
                                           EnableRtl="@(Thread.CurrentThread.CurrentUICulture.Name == "en-US" ? false : true)" Locale="@(Thread.CurrentThread.CurrentUICulture.Name)"
                                           ID="pdfviewer"
                                           DocumentPath="@KayDocumentBase64">
                            <PdfViewerToolbarSettings ToolbarItems="ToolbarItems"></PdfViewerToolbarSettings>
                        </SfPdfViewerServer>
                    </div>
                </div>
            }
        </WindowContent>
    </TelerikWindow>
        </ChildContent>
    </RadzenContent>

}
else
{
    <div class="demo-alert demo-alert-error" role="alert">@translationState.Translate("Unauthorized")</div>
}
